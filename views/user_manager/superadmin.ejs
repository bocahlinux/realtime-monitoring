<!DOCTYPE html>
<html lang="id">
    <head>
        <%- include('../partials/head') %>
    </head>

    <body class="bg-gray-50 dark:bg-govdark min-h-screen text-slate-800 dark:text-slate-100">
        <!-- NAVBAR -->
        <%- include('../partials/navbar') %>

        <div class="flex min-h-screen">
            <!-- SIDEBAR -->
            <%- include('../partials/sidebar', { activePage: 'superadmin-users', user: authUser }) %>

            <!-- MAIN -->
            <main class="flex-1  mt-[60px] w-full layout-container-separo px-4 sm:px-6 lg:px-8 py-4 sm:py-6 space-y-6">
                <h1 class="text-2xl font-bold mb-2">Manajemen User</h1>
                <p class="text-gray-500 dark:text-slate-400">
                    Kelola seluruh pengguna sistem DIGI LAPOR: superadmin, admin, dan operator.
                </p>

                <!-- CARD: CREATE USER -->
                <section class="p-6 bg-white dark:bg-govgray shadow border border-slate-200 dark:border-slate-700 rounded-xl">
                    <h2 class="text-lg font-semibold mb-4">Tambah User Baru</h2>

                    <form action="/superadmin/users/create" method="POST" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm font-medium">Username</label>
                            <input required name="username" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Nama Lengkap</label>
                            <input required name="nama" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Password</label>
                            <input type="password" required name="password" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Level</label>
                            <select name="level" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
                                <option value="admin">Admin</option>
                                <option value="operator">Operator</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium">UPT / Kabupaten</label>
                            <select name="upt" required class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
                                <% uptList.forEach(u => { %>
                                <option value="<%= u.kabupatenName %>">
                                    <%= u.kabupatenName %>
                                </option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="flex items-end">
                            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                Buat User
                            </button>
                        </div>
                    </form>
                </section>

                <!-- TABLE USER LIST -->
                <section class="p-6 bg-white dark:bg-govgray shadow border border-slate-200 dark:border-slate-700 rounded-xl">
                    <h2 class="text-lg font-semibold mb-4">Daftar Semua User</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-gray-800 dark:text-slate-100">
                            <thead class="bg-gray-100 dark:bg-slate-900/70 text-gray-700 dark:text-slate-300 uppercase text-xs">
                                <tr>
                                    <th class="p-2 text-left">Username</th>
                                    <th class="p-2 text-left">Nama</th>
                                    <th class="p-2 text-left">Level</th>
                                    <th class="p-2 text-left">UPT</th>
                                    <th class="p-2 text-left">Status</th>
                                    <th class="p-2 text-left">Dibuat</th>
                                    <th class="p-2 text-center">Aksi</th>
                                </tr>
                            </thead>

                            <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
                                <% users.forEach(u => { %>
                                    <% 
                                    const isAktif = u.status === true; 
                                    const levelClass = 
                                        u.level === "superadmin" ? "bg-yellow-100 text-yellow-800" :
                                        u.level === "admin" ? "bg-blue-100 text-blue-800" :
                                        "bg-emerald-100 text-emerald-800";
                                    %>

                                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                                        <!-- Username -->
                                        <td class="p-3 font-medium"><%= u.username %></td>

                                        <!-- Nama -->
                                        <td class="p-3"><%= u.nama %></td>

                                        <!-- Level -->
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded text-xs font-semibold <%= levelClass %>">
                                                <%= u.level %>
                                            </span>
                                        </td>

                                        <!-- UPT -->
                                        <td class="p-3"><%= u.upt || "-" %></td>

                                        <!-- Status -->
                                        <td class="p-3">
                                            <% if (isAktif) { %>
                                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Aktif</span>
                                            <% } else { %>
                                                <span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">Nonaktif</span>
                                            <% } %>
                                        </td>

                                        <!-- Dibuat -->
                                        <td class="p-3">
                                            <%= u.created_at ? new Date(u.created_at).toLocaleString('id-ID') : '-' %>
                                        </td>

                                        <!-- Aksi -->
                                        <td class="p-3 w-64">
                                            <div class="flex flex-wrap gap-2">

                                            <!-- MODAL TRIGGER UNTUK UPDATE -->
                                            <button 
                                                onclick="openEditModal('<%= u.id %>', '<%= u.nama %>', '<%= u.level %>', '<%= u.upt %>')"
                                                class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs transition">
                                                Edit
                                            </button>

                                            <!-- RESET PASSWORD -->
                                            <form action="/superadmin/users/<%= u.id %>/reset-password" method="POST">
                                                <button 
                                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition">
                                                Reset
                                                </button>
                                            </form>

                                            <!-- TOGGLE STATUS -->
                                            <form action="/superadmin/users/<%= u.id %>/toggle-status" method="POST">
                                                <input type="hidden" name="status" value="<%= isAktif ? 'false' : 'true' %>">

                                                <button 
                                                class="px-3 py-1 <%= isAktif ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-600 hover:bg-green-700' %> text-white rounded text-xs transition">
                                                <%= isAktif ? 'Nonaktif' : 'Aktifkan' %>
                                                </button>
                                            </form>

                                            <!-- DELETE -->
                                            <form action="/superadmin/users/<%= u.id %>/delete" method="POST" onsubmit="return confirm('Yakin hapus user ini?')">
                                                <button 
                                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition">
                                                Hapus
                                                </button>
                                            </form>

                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <div id="editModal" class="fixed inset-0 z-[2000] hidden bg-black/40 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl w-full max-w-md shadow-xl">

                <h3 class="text-lg font-semibold mb-4">Edit User</h3>

                <form id="editForm" method="POST">

                <div class="mb-3">
                    <label class="text-sm font-medium">Nama</label>
                    <input id="editNama" name="nama" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900"/>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">Level</label>
                    <select id="editLevel" name="level" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900">
                    <option value="superadmin">Superadmin</option>
                    <option value="admin">Admin</option>
                    <option value="operator">Operator</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="text-sm font-medium">UPT</label>
                    <select id="editUPT" name="upt" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900">
                    <% uptList.forEach(u => { %>
                        <option value="<%= u.kabupatenName %>"><%= u.kabupatenName %></option>
                    <% }) %>
                    </select>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeEditModal()"
                            class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                    Batal
                    </button>

                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    Simpan
                    </button>
                </div>

                </form>
            </div>
        </div>

        <!-- SNACKBAR -->
        <script>
            if (snackbar) {
                showSnackbar("<%= snackbar %>", "<%= snackbarType || 'success' %>");
            }
            function openEditModal(id, nama, level, upt) {
                document.getElementById("editNama").value = nama;
                document.getElementById("editLevel").value = level;
                document.getElementById("editUPT").value = upt;

                document.getElementById("editForm").action = `/superadmin/users/${id}/update`;

                document.getElementById("editModal").classList.remove("hidden");
            }

            function closeEditModal() {
                document.getElementById("editModal").classList.add("hidden");
            }
        </script>
    </body>
</html>
