<!DOCTYPE html>
<html lang="id">
    <head>
        <%- include('../partials/head') %>
        <style>
            .loader {
                border: 2px solid #fff;
                border-top: 2px solid transparent;
                border-radius: 50%;
                width: 14px;
                height: 14px;
                display: inline-block;
                animation: spin 0.7s linear infinite;
            }
            @keyframes spin { 100% { transform: rotate(360deg); } }
        </style>
    </head>

    <body class="bg-gray-50 dark:bg-govdark min-h-screen text-slate-800 dark:text-slate-100">
        <!-- NAVBAR -->
        <%- include('../partials/navbar') %>

        <div class="flex min-h-screen">
            <!-- SIDEBAR -->
            <%- include('../partials/sidebar', { activePage: 'superadmin-users', user: authUser }) %>

            <!-- MAIN -->
            <main class="flex-1  mt-[60px] w-full layout-container-separo px-4 sm:px-6 lg:px-8 py-4 sm:py-6 space-y-6">
                <h1 class="text-2xl font-bold mb-2">Manajemen User</h1>
                <p class="text-gray-500 dark:text-slate-400">
                    Kelola seluruh pengguna sistem DIGI LAPOR: superadmin, admin, dan operator.
                </p>

                <!-- CARD: CREATE USER -->
                <section class="p-6 bg-white dark:bg-govgray shadow border border-slate-200 dark:border-slate-700 rounded-xl">
                    <h2 class="text-lg font-semibold mb-4">Tambah User Baru</h2>

                    <form action="/superadmin/users/create" method="POST" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm font-medium">Username</label>
                            <input required name="username" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Nama Lengkap</label>
                            <input required name="nama" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Password</label>
                            <input type="password" required name="password" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800"/>
                        </div>

                        <div>
                            <label class="text-sm font-medium">Level</label>
                            <select name="level" class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-800">
                                <option value="admin">Admin</option>
                                <option value="operator">Operator</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium">UPT / Kabupaten</label>
                            <div class="relative mt-2">
                                <input 
                                    type="text"
                                    id="uptSearch"
                                    placeholder="Cari kabupaten..."
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    oninput="filterUptOptions()"
                                    onclick="toggleUptDropdown()"
                                    autocomplete="off"
                                />

                                <!-- Dropdown -->
                                <div id="uptDropdown" class="absolute mt-1 w-full bg-white border rounded-lg shadow-lg max-h-52 overflow-y-auto opacity-0 scale-95 transform transition-all duration-150 origin-top hidden z-50">
                                    <% uptList.forEach(u => { %>
                                        <div 
                                        class="px-3 py-2 hover:bg-blue-100 cursor-pointer transition"
                                        onclick="selectUpt('<%= u.kabupatenName %>')"
                                        >
                                        <%= u.kabupatenName %>
                                        </div>
                                    <% }) %>
                                </div>


                                <!-- REAL VALUE -->
                                <input type="hidden" name="upt" id="uptValue" />
                            </div>

                        </div>

                        <div class="flex items-end">
                            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                Buat User
                            </button>
                        </div>
                    </form>
                </section>

                <!-- TABLE USER LIST -->
                <section class="p-6 bg-white dark:bg-govgray shadow border border-slate-200 dark:border-slate-700 rounded-xl">
                    <h2 class="text-lg font-semibold mb-4">Daftar Semua User</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-gray-800 dark:text-slate-100">
                            <thead class="bg-gray-100 dark:bg-slate-900/70 text-gray-700 dark:text-slate-300 uppercase text-xs">
                                <tr>
                                    <th class="p-2 text-left">Username</th>
                                    <th class="p-2 text-left">Nama</th>
                                    <th class="p-2 text-left">Level</th>
                                    <th class="p-2 text-left">UPT</th>
                                    <th class="p-2 text-left">Status</th>
                                    <th class="p-2 text-left">Dibuat</th>
                                    <th class="p-2 text-center">Aksi</th>
                                </tr>
                            </thead>

                            <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
                                <% users.forEach(u => { %>
                                    <% 
                                    const isAktif = u.status === true; 
                                    const levelClass = 
                                        u.level === "superadmin" ? "bg-yellow-100 text-yellow-800" :
                                        u.level === "admin" ? "bg-blue-100 text-blue-800" :
                                        "bg-emerald-100 text-emerald-800";
                                    %>

                                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                                        <!-- Username -->
                                        <td class="p-3 font-medium"><%= u.username %></td>

                                        <!-- Nama -->
                                        <td class="p-3"><%= u.nama %></td>

                                        <!-- Level -->
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded text-xs font-semibold <%= levelClass %>">
                                                <%= u.level %>
                                            </span>
                                        </td>

                                        <!-- UPT -->
                                        <td class="p-3"><%= u.upt || "-" %></td>

                                        <!-- Status -->
                                        <td class="p-3">
                                            <% if (isAktif) { %>
                                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Aktif</span>
                                            <% } else { %>
                                                <span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">Nonaktif</span>
                                            <% } %>
                                        </td>

                                        <!-- Dibuat -->
                                        <td class="p-3">
                                            <%= u.created_at ? new Date(u.created_at).toLocaleString('id-ID') : '-' %>
                                        </td>

                                        <!-- Aksi -->
                                        <td class="p-3 w-64">
                                            <div class="flex flex-wrap gap-2">

                                            <!-- MODAL TRIGGER UNTUK UPDATE -->
                                            <button 
                                                onclick="openEditModal('<%= u.id %>', '<%= u.nama %>', '<%= u.level %>', '<%= u.upt %>')"
                                                class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs transition">
                                                Edit
                                            </button>

                                            <!-- RESET PASSWORD -->
                                            <form action="/superadmin/users/<%= u.id %>/reset-password" method="POST">
                                                <button 
                                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition">
                                                Reset
                                                </button>
                                            </form>

                                            <!-- TOGGLE STATUS -->
                                            <form action="/superadmin/users/<%= u.id %>/toggle-status" method="POST">
                                                <input type="hidden" name="status" value="<%= isAktif ? 'false' : 'true' %>">

                                                <button 
                                                class="px-3 py-1 <%= isAktif ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-600 hover:bg-green-700' %> text-white rounded text-xs transition">
                                                <%= isAktif ? 'Nonaktif' : 'Aktifkan' %>
                                                </button>
                                            </form>

                                            <!-- DELETE -->
                                            <form action="/superadmin/users/<%= u.id %>/delete" method="POST" onsubmit="return confirm('Yakin hapus user ini?')">
                                                <button 
                                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition">
                                                Hapus
                                                </button>
                                            </form>

                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <div id="editModal" class="fixed inset-0 z-[2000] hidden bg-black/40 backdrop-blur-sm flex items-center justify-center transition-all duration-200">
            <div id="editModalContent"
                class="bg-white dark:bg-slate-800 p-6 rounded-xl w-full max-w-md 
                        shadow-xl transform scale-95 opacity-0 transition-all duration-200">

                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                    Edit User
                </h3>

                <form id="editForm" method="POST">
                    <div class="mb-3">
                        <label class="text-sm font-medium">Nama</label>
                        <input id="editNama" name="nama"
                            class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900 focus:ring-2 focus:ring-blue-500"/>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm font-medium">Level</label>
                        <select id="editLevel" name="level"
                                class="w-full mt-1 px-3 py-2 rounded-lg border dark:border-slate-700 dark:bg-slate-900 focus:ring-2 focus:ring-blue-500">
                            <option value="superadmin">Superadmin</option>
                            <option value="admin">Admin</option>
                            <option value="operator">Operator</option>
                        </select>
                    </div>

                    <!-- UPT Dropdown -->
                    <div class="mb-3">
                        <label class="text-sm font-medium">UPT</label>
                        <div class="relative mt-2">
                            <input id="editUptSearch"
                                type="text"
                                placeholder="Cari kabupaten..."
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-900"
                                oninput="filterEditUptOptions()"
                                onclick="toggleEditUptDropdown()"
                                autocomplete="off"/>

                            <div id="editUptDropdown"
                                class="absolute mt-1 w-full bg-white dark:bg-slate-900 border rounded-lg shadow-lg 
                                    max-h-52 overflow-y-auto hidden opacity-0 scale-95 origin-top
                                    transition-all duration-150 z-50">
                                <% uptList.forEach(u => { %>
                                    <div class="px-3 py-2 hover:bg-blue-100 dark:hover:bg-slate-700 cursor-pointer transition edit-upt-option"
                                        onclick="selectEditUpt('<%= u.kabupatenName %>')">
                                        <%= u.kabupatenName %>
                                    </div>
                                <% }) %>
                            </div>

                            <input type="hidden" id="editUptValue" name="upt"/>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="closeEditModal()"
                                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            Batal
                        </button>

                        <button id="btnSaveEdit"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2">
                            <span>Simpan</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <!-- SNACKBAR -->
        <script>
            if (snackbar) {
                showSnackbar("<%= snackbar %>", "<%= snackbarType || 'success' %>");
            }
            function openEditModal(id, nama, level, upt) {
                const modal = document.getElementById("editModal");
                const content = document.getElementById("editModalContent");
                
                // Set data
                document.getElementById("editNama").value = nama;
                document.getElementById("editLevel").value = level;
                document.getElementById("editUptSearch").value = upt || "";
                document.getElementById("editUptValue").value = upt || "";

                document.getElementById("editForm").action = `/superadmin/users/${id}/update`;

                // Show modal
                modal.classList.remove("hidden");

                // Animasi fade + scale
                setTimeout(() => {
                    content.classList.remove("opacity-0", "scale-95");
                    content.classList.add("opacity-100", "scale-100");
                }, 10);

                // Fokus otomatis ke input nama
                setTimeout(() => document.getElementById("editNama").focus(), 150);
            }

            function showEditUptDropdown() {
                const dd = document.getElementById("editUptDropdown");
                dd.classList.remove("hidden");
                requestAnimationFrame(() => {
                    dd.classList.remove("opacity-0", "scale-95");
                    dd.classList.add("opacity-100", "scale-100");
                });
            }

            function hideEditUptDropdown() {
                const dd = document.getElementById("editUptDropdown");
                dd.classList.add("opacity-0", "scale-95");
                dd.classList.remove("opacity-100", "scale-100");
                setTimeout(() => dd.classList.add("hidden"), 120);
            }

            function toggleEditUptDropdown() {
                const dd = document.getElementById("editUptDropdown");

                if (dd.classList.contains("hidden")) {
                    dd.classList.remove("hidden");
                    setTimeout(() => {
                        dd.classList.remove("opacity-0", "scale-95");
                        dd.classList.add("opacity-100", "scale-100");
                    }, 10);
                } else {
                    hideEditUptDropdown();
                }
            }

            function filterEditUptOptions() {
                const input = document.getElementById("editUptSearch").value.toLowerCase();
                const items = document.querySelectorAll(".edit-upt-option");

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(input) ? "block" : "none";

                    // highlight search
                    if (input.length > 0) {
                        item.innerHTML = item.textContent.replace(
                            new RegExp(input, "gi"),
                            match => `<span class="bg-yellow-200 dark:bg-yellow-600 text-black dark:text-white">${match}</span>`
                        );
                    } else {
                        item.innerHTML = item.textContent;
                    }
                });
            }

            function selectEditUpt(value) {
                document.getElementById("editUptSearch").value = value;
                document.getElementById("editUptValue").value = value;
                hideEditUptDropdown();
            }

            function closeEditModal() {
                const modal = document.getElementById("editModal");
                const content = document.getElementById("editModalContent");

                content.classList.add("opacity-0", "scale-95");
                content.classList.remove("opacity-100", "scale-100");

                setTimeout(() => modal.classList.add("hidden"), 150);
            }
            
            function showUptDropdown() {
                const dd = document.getElementById("uptDropdown");
                dd.classList.remove("hidden");

                // Animasi open
                requestAnimationFrame(() => {
                    dd.classList.remove("opacity-0", "scale-95");
                    dd.classList.add("opacity-100", "scale-100");
                });
            }

            function hideUptDropdown() {
                const dd = document.getElementById("uptDropdown");

                // Animasi close
                dd.classList.add("opacity-0", "scale-95");
                dd.classList.remove("opacity-100", "scale-100");

                // Tunggu animasi selesai, lalu hide
                setTimeout(() => dd.classList.add("hidden"), 130);
            }

            function toggleUptDropdown() {
                const dd = document.getElementById("uptDropdown");

                if (dd.classList.contains("hidden")) {
                    showUptDropdown();
                } else {
                    hideUptDropdown();
                }
            }

            function filterUptOptions() {
                const input = document.getElementById("uptSearch").value.toLowerCase();
                const items = document.querySelectorAll("#uptDropdown > div");

                items.forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(input)
                    ? "block"
                    : "none";
                });
            }

            function selectUpt(value) {
                document.getElementById("uptSearch").value = value;
                document.getElementById("uptValue").value = value;
                hideUptDropdown();
            }

            // close dropdown on outside click
            
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeEditModal();
            });

            document.getElementById("btnSaveEdit").addEventListener("click", function () {
                this.innerHTML = `<span class="loader"></span> Menyimpan...`;
            });

            /* Click outside close */
            document.addEventListener("click", (e) => {
                const modal = document.getElementById("editModal");
                const content = document.getElementById("editModalContent");

                if (!modal.classList.contains("hidden") && !content.contains(e.target) && !e.target.closest("button[onclick^='openEditModal']")) {
                    closeEditModal();
                }
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest("#editUptDropdown") && !e.target.closest("#editUptSearch")) {
                    hideEditUptDropdown();
                }
            });
        </script>
    </body>
</html>
